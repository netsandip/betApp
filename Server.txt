var express = require('express');
var bodyParser = require('body-parser');
var app = express();
var port = process.env.PORT || 3001;
var gcm = require('node-gcm');
var config = require('./config');
var udf = require('./utils/utilFunctions');

var cradle = require('cradle');
var connection = new(cradle.Connection)('https://ashokustglobal.cloudant.com', 443, {
      auth: { username: 'ashokustglobal', password: 'ashokUstGlobal@1234' }
  });
  
var registrationDB = connection.database('registration');
var preregistrationDB = connection.database('preregistration');
var notificationsDB = connection.database('notifications');
var postsDB = connection.database('post');



var sg = require('sendgrid')('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');


var date = require('date-and-time');
var upsAPI = require('shipping-ups');
var fedexAPI = require('./lib/index');
var newfedexAPI = require('./lib_fed/index');
var util = require('util');

var fedex = new fedexAPI({
  environment: config.FEDEX_ENVIRONMENT,
  debug: false,
  key: config.KEY,
  password: config.PASSWORD,
  account_number: config.ACCOUNT_NUMBER,
  meter_number: config.METER_NUMBER,
  imperial: true // set to false for metric
});

var _newfedexAPI = new newfedexAPI({
	environment: config.FEDEX_ENVIRONMENT,
	debug: true,
	key:  config.KEY,
	password: config.PASSWORD,
	account_number: config.ACCOUNT_NUMBER,
	meter_number: config.METER_NUMBER,
	imperial: true // set to false for metric
});

var ups = new upsAPI({
    environment: config.UPS_ENVIRONMENT,
    username: config.USERNAME,
    password: config.PASSWORD,
    access_key: config.ACCESS_KEY,
    imperial: true // set to false for metric
  });
 
app.use(bodyParser.json());

app.post('/checkDB', function(req, postres)
{
	udf.LogObject.timestamp();
	udf.LogObject.currentDate();

	var variableABC = "A B C";	
	variableABC = variableABC.replace('B', 'D') //output: 'A D C'
	console.log(variableABC);

	var str = "123, 124, 234,252";
	var arr = str.split(",");
	//arr = arr.map(function (val) { return +val + 1; });
	console.log(arr);

});

app.post('/resetpassword', function(req, postres){
	try
	{		
		var emailid = req.body.emailID;			
		var found = false;
		registrationDB.view('vregistration/byemailid', { key: emailid },function (err, doc) {		
		  try {			  
			  if(doc.length > 0)
			  row = doc[0].value; 	
			  else {
				  postres.status(200).send({ status: 'Failure', message: 'User not found!' });
				  return;
			  }
			  if (row.email_ID.toUpperCase() === emailid.toUpperCase())
				{					
					found = true;
					var validOTP = "";
					var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
					for (var i = 0; i < 5; i++)
					{
						validOTP += possible.charAt(Math.floor(Math.random() * possible.length));
					}				
															
					registrationDB.merge(row._id, {
							  pass_verficationCode: validOTP
						  }, function (err, res) {
								if (err) {									
									udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));
									postres.status(500).send({ status: 'Failure', message: 'Internal Server Error!' });
									return;
								}									
							  
								// start Add by e-mail code 
								var request = sg.emptyRequest({
								method: 'POST',
								path: '/v3/mail/send',
								body: {
									personalizations: [
									{
										to: [
										{
											email: emailid
										}
										],
										subject: 'Kits4Life - Forgotten password reset'
									}
									],
									from: {
									email: 'kits4life.support@ust-global.com'
									},
									content: [
									{
										type: 'text/html',
										value: 'Dear '+ emailid +', <br /><br /> You recently requested to reset your password for your Kits4life Account. Use OTP to reset your password.:-  ' + validOTP + ' <br /><br /> If you did not request a password reset, please ignore this email or send email to kits4life.support@ust-global.com to let us know. This password reset is only valid for next 1 day.' + 
			 ' <br /><br /><br /> Thanks, <br /> Kits4life support Team, <br /> kits4life.support@ust-global.com.'
									}
									]
								}
								});

								sg.API(request, function (error, response) {
								if (error) {
									console.log('Error response received');
								}	
									udf.LogObject.Log('Response.headers', 'Info', JSON.stringify(response.headers));
									udf.LogObject.Log('reset password request Success '+ emailid, 'Info', JSON.stringify(response.headers));
									postres.send({ status: 'Success' });
								});

						  });					
				}			  		 
			}
		catch (err) {
			udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));
			postres.status(500).send({ status: 'Failure', message: 'Internal Server Error!' });
			return;
			}
			if (!found) {
				udf.LogObject.Log('resetpassword -> User Not found', 'Info', emailid);
				postres.status(200).send({ status: 'Failure', message: 'User not found!' });
			}
      });  
		
	}
	catch (err)
	{
		udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));
		postres.status(500).send({ status: 'Failure', message: 'Internal Server Error!' });
	}
});

app.post('/validateresetpassword', function(req, postres){
	try
	{
		var emailid = req.body.emailID;			
		var otpCode = req.body.otpCode;
		var valid = false;
		registrationDB.view('vregistration/byemailid', { key: emailid }, function (err, doc) {
				if(doc.length > 0)
				  row = doc[0].value; 	
				  else {
					udf.LogObject.Log('User Not found', 'Info', emailid);
					postres.status(200).send({ status: 'Failure', message: 'User not found!' });
					return;
				}
				if (row.email_ID.toUpperCase() === emailid.toUpperCase() && row.pass_verficationCode.length > 0 && otpCode !== undefined)
				{					
					if(row.pass_verficationCode === otpCode)
					{
						valid = true;
						postres.status(200).send({ status: 'Success' });						
					}					
				}					
			
			if (!valid){
				udf.LogObject.Log('invalid OTP verification code!', 'Info', emailid);
				postres.status(200).send({ status: 'Failure', message: 'invalid OTP verification code!' });
			}
				
		});
	}
	catch (err)
	{
		udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));
		postres.status(500).send({ status: 'Failure', message: 'Internal Server Error!' });
	}
		
});


app.post('/changepassword', function(req, postres){
	try
	{
		var emailid = req.body.emailID;			
		var npasswod = req.body.newpassword;
		var found = false;
		registrationDB.view('vregistration/byemailid', { key: emailid }, function (err, doc) {
			if(doc.length > 0)
				  row = doc[0].value; 	
				  else {
						udf.LogObject.Log('changepassword -> User Not found', 'Info', emailid);
					  postres.status(200).send({ status: 'Failure', message: 'User not found!' });
					  return;
				}
				if (row.email_ID.toUpperCase() === emailid.toUpperCase())
				{
					found = true;
						registrationDB.merge(row._id, {
							  password: npasswod
						  }, function (err, res) {
								if (err) {
									udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));
									postres.status(500).send({ status: 'Failure', message: 'Internal Server Error!' });
									return;
								}																
							  
								// start Add by e-mail code 
								var request = sg.emptyRequest({
								method: 'POST',
								path: '/v3/mail/send',
								body: {
									personalizations: [
									{
										to: [
										{
											email: emailid
										}
										],
										subject: 'Kits4Life - change password notification'
									}
									],
									from: {
									email: 'kits4life.support@ust-global.com'
									},
									content: [
									{
										type: 'text/html',
										value: 'Dear '+ emailid +', <br /><br /> You recently requested to change  password for your Kits4life Account. <br /><br /> If you did not request a password reset, please ignore this email or send email to kits4life.support@ust-global.com to let us know. This password reset is only valid for next 1 day.' + 
			 ' <br /><br /><br /> Thanks, <br /> Kits4life support Team, <br /> kits4life.support@ust-global.com.'
									}
									]
								}
								});

								sg.API(request, function (error, response) {
								if (error) {
									udf.LogObject.Log(error.message, 'Error', JSON.stringify(error.stack));
								}
									udf.LogObject.Log('Response.body', 'Info', JSON.stringify(response.body));								
								});

						  });
						  postres.status(200).send({ status: 'Success' });						
				}				
			
			if (!found) {
				udf.LogObject.Log('changepassword -> User Not found', 'Info', emailid);
				postres.status(200).send({ status: 'Failure', message: 'User not found!' });
			}
		});
	}
	catch (err)
	{
		udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));
		postres.status(500).send({ status: 'Failure', message: 'Internal Server Error!' });;
	}
		
});


app.post('/retoldpassword', function(req,postres) {
	try
	{
		var emailid = req.body.emailID;			
		var found = false;
		registrationDB.view('vregistration/all', function (err, res) {
				res.forEach(function (row) {
				if (row.email_ID.toUpperCase() === emailid.toUpperCase())
				{
					found = true;
					postres.send({ status: 'Success', oldpassword: row.password });
				}				
			});
			if(!found)
				{					
					postres.status(200).send({ status: 'Failure', message: 'User not found!' });
				}
		});
		
	}
	catch (err)
	{
		udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));
		postres.status(500).send({ status: 'Failure', message: 'Internal Server Error!' });
	}
});


app.post('/generateAuthCode', function (req, postres) {
	try
	{		
		var emailid = req.body.emailID;		
		var reqotp = "";
		var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
		for (var i = 0; i < 5; i++)
		{
			reqotp += possible.charAt(Math.floor(Math.random() * possible.length));
		}				
												
		preregistrationDB.save({
				  email_ID: emailid,
				  reg_verficationCode: reqotp
			  }, function (err, res) {
					if (err) {
						udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));
						postres.sendStatus(200);
					}																
				  
					// start Add by e-mail code 
					var request = sg.emptyRequest({
					method: 'POST',
					path: '/v3/mail/send',
					body: {
						personalizations: [
						{
							to: [
							{
								email: emailid
							}
							],
							subject: 'Kits4Life - Authorization code for MSRO registration'
						}
						],
						from: {
						email: 'kits4life.support@ust-global.com'
						},
						content: [
						{
							type: 'text/html',
							value: 'Dear '+ emailid +', <br /><br /> Thanks for downloading the kits4life application, kindly enter the following:-  ' + reqotp + ' <br /><br /> one time passcode in the kits4life mobile application, to complete your registration. this passcode is valid only for 24 hours <br> <br> if you did not request for this passcode, kindly ignore this email or inform us at kits4life.support@ust-global.com' + 
 ' <br /><br /><br /> Thanks, <br /> Kits4life support Team, <br /> kits4life.support@ust-global.com.'
						}
						]
					}
					});

					sg.API(request, function (error, response) {
					if (error) {
						udf.LogObject.Log(error.message, 'Error', JSON.stringify(error.stack));
					}
						udf.LogObject.Log('Response.body', 'Info', JSON.stringify(response.body));								
						postres.status(200).send({ status: 'Success' });	
					});

			  });	

		
	}
	catch (err)
	{
		udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));
		postres.status(500).send({ status: 'Failure', message: 'Internal Server Error!' });
	}
	
});

app.post('/validateauthcode', function(req, postres){
	try
	{
		var emailid = req.body.emailID;			
		var reqAuthCode = req.body.reqAuthCode;
		var valid = false;
		preregistrationDB.view('vpreregistration/byemailid', { key: emailid }, function (err, doc) {
			if(doc.length > 0)
			  row = doc[0].value; 	
			  else {
				  postres.status(200).send({ status: 'Success', message: 'User not found!' });
				  return;
			  }
			if (row.email_ID.toUpperCase() === emailid.toUpperCase() && row.reg_verficationCode.length > 0 && reqAuthCode !== undefined)
			{	
				if(row.reg_verficationCode === reqAuthCode)
				{
					valid = true;
				}					
			}

			if (!valid) {				
				postres.status(200).send({ status: 'Success', message: 'invalid OTP verification code!' });
				return;
			}
			
			postres.status(200).send({ status: 'Success' });													
			});
			
	}
	catch (err)
	{
		udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));
		postres.status(500).send({ status: 'Failure', message: 'Internal Server Error!' });
	}
		
});



app.post('/requestForAvailability', function(req, postres){
	var docid = req.body.doc_id;
	var row;
	var registrationrow;
	try 
	{
		postsDB.view('vposts/bydocid', { key: docid }, function (err, doc) {
			if(doc.length > 0)
				row = doc[0].value; 	
			else 
			{
				postres.status(200).send({ status: 'Success', message: 'Document ID not found' });
				return;
			}
			registrationDB.view('vregistration/byemailid', { key: row.user_email }, function (err, doc) {
				if(doc.length > 0)
				registrationrow = doc[0].value; 	
				  else {
					  postres.status(200).send({ status: 'Failure', message: 'User not found!' });
					  return;
				}
				var stateCode = GetStateCode(registrationrow.state);
				_newfedexAPI.pickupAvailability({
					PickupAddress: {
					StreetLines: [
						registrationrow.street
					],
					City: registrationrow.address,
					StateOrProvinceCode: registrationrow.stateCode,
					PostalCode: registrationrow.zipcode,
					CountryCode: 'US'
					},
					PickupRequestType: 'FUTURE_DAY',
					Carriers: 'FDXE'
				},  function(err, res) {
					if(err) {
						return udf.LogObject.Log(err.message, 'Error', JSON.stringify(util.inspect(err, {depth: null}))); 			
					}			
					udf.LogObject.Log('requestForAvailability', 'Info', JSON.stringify(util.inspect(res.Options, {depth: null})));
					postres.status(200).send({ status: 'Success', availability: res.Options  });
				});			
				
			});	
																
			});	
	}
	catch(err)
	{
		udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));
		postres.status(500).send({ status: 'Failure', message: 'Internal Server Error!' });
	}
});


app.post('/cancelPickup', function(req, postres){
	_newfedexAPI.cancelPickup({
		CarrierCode: 'FDXE',
		PickupConfirmationNumber: '',
		ScheduledDate: '2017-09-10',
		Location: '',
		Remarks: ''
	  },  function(err, res) {
		if(err) {
		  return console.log(util.inspect(err, {depth: null}));
		}
		console.log(util.inspect(res, {depth: null}));
		postres.status(200).send({ status: 'Success' });
	});
});


app.post('/requestForPickup', function(req, postres){
	
	try{
		var docid = req.body.doc_id;
		var carrierCode = req.body.Carrier;
		var pickupDate = req.body.PickupDate;
		var row;
		postsDB.view('vposts/bydocid', { key: docid }, function (err, doc) {
			if(doc.length > 0)
				row = doc[0].value; 	
			else 
			{
				postres.status(200).send({ status: 'Success', message: 'Document ID not found' });
				return;
			}
			registrationDB.view('vregistration/byemailid', { key: row.user_email }, function (err, doc) {
				if(doc.length > 0)
				registrationrow = doc[0].value; 	
				  else {
					  postres.status(200).send({ status: 'Failure', message: 'User not found!' });
					  return;
				}
				var stateCode = GetStateCode(registrationrow.state);
				_newfedexAPI.pickup({
					OriginDetail: {
					  UseAccountAddress: false,
					  PickupLocation: {
						Contact: {
						  PersonName: registrationrow.first_name + registrationrow.last_name,
						  CompanyName: registrationrow.organization,
						  PhoneNumber: registrationrow.mobile_number
						},
						Address: {
						  StreetLines: [
							registrationrow.street
						  ],
						  City: registrationrow.address,
						  StateOrProvinceCode: registrationrow.stateCode,
						  PostalCode: registrationrow.zipcode,
						  CountryCode: 'US',
						  'Residential': false
						}
					  },
					  PackageLocation: 'FRONT',
					  ReadyTimestamp: pickupDate,
					  CompanyCloseTime: '18:00:00'
					},
					PackageCount: 1,
					CarrierCode: 'FDXE',
					Remarks: row.categories,
					CommodityDescription: row.categories
				  },  function(err, res) {
					if(err) {
						return udf.LogObject.Log(err.message, 'Error', JSON.stringify(util.inspect(err, {depth: null}))); 
					}
					udf.LogObject.Log('requestForPickup', 'Info', JSON.stringify(util.inspect(res.Options, {depth: null})));
					postres.status(200).send({ status: 'Success', message: 'Pickup process initiated!' });
				});			
				
			});	
																
			});		
	}
	catch (err)
	{
		udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));
		postres.status(500).send({ status: 'Failure', message: 'Internal Server Error!' });
	}
});

app.post('/requestForShipment', function(req, postres){
	try
	{
		var siteemailid = req.body.siteEmailID;
		var aidemailid = req.body.aidEmailID;
		var transporttype = req.body.transporttype; // "FedEx/UPS"
		var docid = req.body.doc_id;
		var siteRow;
		var recipientRow;
		var row;
		let now = new Date();	
		var siteStatecode;
		var recipentStatecode;
		postsDB.view('vposts/bysiteidbyaidid', { key: siteemailid, value: aidemailid }, function (err, doc) {			
			if(doc.length > 0){
				row = doc[0].value; 

				registrationDB.view('vregistration/byemailid', { key: row.user_email }, function (err, doc) {
					if(doc.length > 0)
					siteRow = doc[0].value; 	
					  else {
						  postres.status(200).send({ status: 'Failure', message: 'User not found!' });
						  return;
					}
					siteStatecode = GetStateCode(siteRow.state);	
					registrationDB.view('vregistration/byemailid', { key: row.confirmation_user_email }, function (err, rdoc) {
						if(rdoc.length > 0)
						recipientRow = rdoc[0].value; 	
						  else {
							  postres.status(200).send({ status: 'Failure', message: 'User not found!' });
							  return;
						}
						recipentStatecode = GetStateCode(recipientRow.state);
						if(transporttype === 'FEDEX')
						{
							var stampdate = new Date();
							var dimensionArray = row.dimension.split("X");
							fedex.ship({
							  RequestedShipment: {
								ShipTimestamp: new Date(stampdate.getTime() + (24*60*60*1000)).toISOString(),
								DropoffType: 'REGULAR_PICKUP',
								ServiceType: 'FEDEX_GROUND',
								PackagingType: 'YOUR_PACKAGING',
								Shipper: {
								  Contact: {
									PersonName: siteRow.first_name + siteRow.last_name,
									CompanyName: siteRow.organization,
									PhoneNumber: siteRow.mobile_number
								  },
								  Address: {
									StreetLines: [
										siteRow.street
									],
									City: siteRow.address,
									StateOrProvinceCode: siteStatecode,
									PostalCode: siteRow.zipcode,
									CountryCode: 'US'
								  }
								},
								Recipient: {
								  Contact: {
									PersonName: recipientRow.first_name + recipientRow.last_name,
									CompanyName: recipientRow.organization,
									PhoneNumber: recipientRow.mobile_number
								  },
								  Address: {
									StreetLines: [
										recipientRow.street
									],
									City: siteRow.address,
									StateOrProvinceCode: recipentStatecode,
									PostalCode: recipientRow.zipcode,
									CountryCode: 'US',
									Residential: false
								  }
								},
								ShippingChargesPayment: {
								  PaymentType: 'RECIPIENT',
								  Payor: {
									ResponsibleParty: {
									  AccountNumber: row.fedex_account_number
									}
								  }
								},
								LabelSpecification: {
								  LabelFormatType: 'COMMON2D',
								  ImageType: 'PDF',
								  LabelStockType: 'PAPER_4X6'
								},
								PackageCount: '1',
								RequestedPackageLineItems: [{
								  SequenceNumber: 1,
								  GroupPackageCount: 1,
								  Weight: {
									Units: 'LB',
									Value: row.weight
								  },
								  Dimensions: {
									Length: dimensionArray[0],
									Width: dimensionArray[1],
									Height: dimensionArray[2],
									Units: 'IN'
								  }
								}]
							  }
							}, function(err, res) {
							  if(err) {
								return udf.LogObject.Log(err.message, 'Error', JSON.stringify(util.inspect(err, {depth: null}))); 
							  }
							  var _trackingNumber = res.CompletedShipmentDetail.CompletedPackageDetails[0].TrackingIds[0].TrackingNumber;
							  //console.log(util.inspect(res.CompletedShipmentDetail.CompletedPackageDetails[0].TrackingIds[0].TrackingNumber, {depth: null}));
							  
							  notificationsDB.save({
								notification_message: config.SITE_CONFIRM_ORDER_SHIPMENT_MSG.replace('{tracking#}',  _trackingNumber) , 
								eventtimedate: date.format(now, 'YYYY/MM/DD HH:mm:ss'), 
								readflag: false, 
								post_docid: docid,
								email_id: aidemailid,
								created_at: date.format(now, 'YYYY/MM/DD HH:mm:ss')
							  }, function (err, res) {
								  // Handle response
								  if(err)
									udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));
									  //console.log("Post notification entry successfull for docid " + docid); // audit-log
									udf.LogObject.Log("requestforShipment -> Post notification entry successfull for docid " , 'Info', + docid);
							  });
							});
						}
						else if(transporttype === "UPS")
						{
							
						}

					});
					
				});
				
				postres.status(200).send({ status: 'Success', message: 'Shipment process initiated!' });	
				
				
			}	
			else 
			{
				udf.LogObject.Log('requestforShipment -> User Not found', 'Info', emailid);  
				postres.status(200).send({ status: 'Failure', message: 'User not found!' });
				return;
			}
		});	
	}
	catch (err)
	{
		udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));
		postres.status(500).send({ status: 'Failure', message: 'Internal Server Error!' });
	}
		
});

app.post('/GenerateNotification', function(req,postres){
		
	try
	{			
			var action = req.body.action;
			var docID = req.body.doc_id;
			var siteEmail = req.body.siteEmailID;
			var aidEmail = req.body.aidEmailID;
			var first_name = req.body.first_name;
			var last_name = req.body.last_name;
			
			registrationDB.view('vregistration/byemailid', { key: siteEmail }, function (err, doc) {
			if(doc.length > 0)
			{
				row = doc[0].value; 	
				registrationDB.view('vregistration/byemailid', { key: aidEmail }, function (err, doc) {
					if(doc.length > 0)
					{
						row = doc[0].value; 	
						switch(action)
						{
							case config.AID_REQUEST_ORDER_SELF_PICKUP:		
								SendActionNotificationMessage(config.AID_REQUEST_ORDER_SELF_PICKUP, config.AID_REQUEST_ORDER_SELF_PICKUP_MSG, docID, siteEmail, aidEmail, first_name, last_name);	
								
								postres.send({ status: 'SUCCESS' });
							break;
							
							case config.SITE_CONFIRM_ORDER_SELF_PICKUP:
								SendActionNotificationMessage(config.SITE_CONFIRM_ORDER_SELF_PICKUP, config.SITE_CONFIRM_ORDER_SELF_PICKUP_MSG, docID, siteEmail, aidEmail, first_name, last_name);
								postres.send({ status: 'SUCCESS' });
							break;
							
							case config.AID_REQUEST_ORDER_SHIPMENT:
								SendActionNotificationMessage(config.AID_REQUEST_ORDER_SHIPMENT, config.AID_REQUEST_ORDER_SHIPMENT_MSG, docID, siteEmail, aidEmail, first_name, last_name);
								postres.send({ status: 'SUCCESS' });
							break;
							
							case config.SITE_CONFIRM_ORDER_SHIPMENT:
								SendActionNotificationMessage(config.SITE_CONFIRM_ORDER_SHIPMENT, config.SITE_CONFIRM_ORDER_SHIPMENT_MSG, docID, siteEmail, aidEmail, first_name, last_name);
								postres.send({ status: 'SUCCESS' });
							break;
							
							case config.SITE_SELFPICKUP_COMPLETE:
								SendActionNotificationMessage(config.SITE_SELFPICKUP_COMPLETE, config.SITE_SELFPICKUP_COMPLETE_MSG, docID, siteEmail, aidEmail, first_name, last_name);
								postres.send({ status: 'SUCCESS' });
							break;
							
							case config.SITE_SHIPMENTPICKUP_COMPLETE:
								SendActionNotificationMessage(config.SITE_SHIPMENTPICKUP_COMPLETE, config.SITE_SHIPMENTPICKUP_COMPLETE_MSG, docID, siteEmail, aidEmail, first_name, last_name);
								postres.send({ status: 'SUCCESS' });
							break;				
							
						}
					}
					else 
					{
						postres.status(200).send({ status: 'Failure', message: 'User not found!' });
						udf.LogObject.Log('GenerateNotification -> User Not found', 'Info', emailid);
						return;
					}
					});
				
			}
			  else {
				  postres.status(200).send({ status: 'Failure', message: 'User not found!' });
				  udf.LogObject.Log('GenerateNotification -> User Not found', 'Info', emailid);
				  return;
			  }
			});
	}
	catch (err) {
		udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));
		res.status(500).send({ status: 'Failure', message: 'Internal Server Error!' });
	}
	
});

app.listen(port, function(){
    console.log('app listening on port '+ port);
})

function SendActionNotificationMessage(action, action_msg, docid, siteEmailID, aidEmailID, first_name, last_name)
{ 	
	registrationDB.view('vregistration/all', function (err, res) {
		let isNotifiedsite = false;
	  res.forEach(function (row) {
		  try {
			  switch(action)
			  {
				  case config.AID_REQUEST_ORDER_SELF_PICKUP:		
						if (row.email_ID === siteEmailID)
						{							
							isNotifiedsite = true;
							SendMessage(row.refreshToken, action, action_msg, docid, siteEmailID, aidEmailID, first_name, last_name, isNotifiedsite);							
						}						
					break;
					
					case config.SITE_CONFIRM_ORDER_SELF_PICKUP:
						if (row.email_ID === aidEmailID)
						{	
							isNotifiedsite = false;
							SendMessage(row.refreshToken, action, action_msg, docid, siteEmailID, aidEmailID, first_name, last_name, isNotifiedsite);							
						}	
					break;
					
					case config.AID_REQUEST_ORDER_SHIPMENT:
						if (row.email_ID === siteEmailID)
						{							
							isNotifiedsite = true;
							SendMessage(row.refreshToken, action, action_msg, docid, siteEmailID, aidEmailID, first_name, last_name, isNotifiedsite);							
						}	
					break;
					
					case config.SITE_CONFIRM_ORDER_SHIPMENT:
						if (row.email_ID === aidEmailID)
						{							
							isNotifiedsite = false;
							SendMessage(row.refreshToken, action, action_msg, docid, siteEmailID, aidEmailID, first_name, last_name, isNotifiedsite);							
						}	
					break;
					
					case config.SITE_SELFPICKUP_COMPLETE:
						if (row.email_ID === aidEmailID)
						{							
							isNotifiedsite = false;
							SendMessage(row.refreshToken, action, action_msg, docid, siteEmailID, aidEmailID, first_name, last_name, isNotifiedsite);							
						}	
					break;
					
					case config.SITE_SHIPMENTPICKUP_COMPLETE:
						if (row.email_ID === aidEmailID)
						{			
							isNotifiedsite = false;
							SendMessage(row.refreshToken, action, action_msg, docid, siteEmailID, aidEmailID, first_name, last_name, isNotifiedsite);							
						}	
					break;			
			  } 
			  		 
		  }
		catch (err) {
			udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));
			res.status(500).send({ status: 'Failure', message: 'Internal Server Error!' });
		}
      });
  }); 
	
}

function SendMessage(refreshToken, action, action_msg, docid, siteEmailID, aidEmailID, first_name, last_name, isNotifiedsite)
{
	var regTokens = [];
	// Set up the sender with your GCM/FCM API key (declare this once for multiple messages) 
	var sender = new gcm.Sender(FCMServerKey);
	let now = new Date();
    let email_id;
	
	if(refreshToken !== undefined && refreshToken.length > 0 && refreshToken !== null)
	{
			regTokens.push(refreshToken);
			// Specify which registration IDs to deliver the message to 
			//
			
			if (typeof regTokens !== 'undefined' && regTokens.length > 0)
			{										
				// Prepare a message to be sent 
				var message = new gcm.Message({
					data: { action: action,
							action_msg: action_msg,
							doc_id: docid,
							siteEmail: siteEmailID,
							aidEmail: aidEmailID,
							first_name: first_name,
							last_name: last_name
					}
				});									
				
				// Actually send the message 
				sender.send(message, { registrationTokens: regTokens }, function (err, response) {
					if (err) udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));
					else udf.LogObject.Log('SendMessage -> Response.headers', 'Info', JSON.stringify(response));
				});
				
				if(isNotifiedsite)
				{
					email_id = siteEmailID;
				}
				else{
					email_id = aidEmailID;
				}
				
				//Entry to pushnotifications database							
				notificationsDB.save({
					notification_message: action_msg, 
					eventtimedate: date.format(now, 'YYYY/MM/DD HH:mm:ss'), 
					readflag: false, 
					post_docid: docid,
					email_id: email_id
				  }, function (err, res) {
					  // Handle response
					  if(err)
						  udf.LogObject.Log(err.message, 'Error', JSON.stringify(err.stack));					  
					  	  udf.LogObject.Log('SendMessage -> Post notification entry successfull for docid ', 'Info', docid);
				  });
				
				console.log("SendMessage -> Message Sent Successfully");
			}
			else 
			{
				//Audit log - Say that siteEmail doesnt have registered device				
				udf.LogObject.Log('SendMessage -> Email user doesnt have registered device ', 'Info', docid);
			}
	}
	else 
	{
		//Audit log - Say that siteEmail doesnt have registered device		
		udf.LogObject.Log('SendMessage -> Email user doesnt have registered device  ', 'Info', docid);
	}

}

function GetStateCode(state)
{	
	switch(state)
	{
		case 'Alabama':
			return 'AL';
			case 'Alaska':
			return 'AK';

			case 'Arizona':
			return 'AZ';

			case 'Arkansas':
			return 'AR';

			case 'California':
			return 'CA';

			case 'Colorado':
			return 'CO';

			case 'Connecticut':
			return 'CT';

			case 'Delaware':
			return 'DE';

			case 'District of Columbia':
			return 'DC';

			case 'Florida':
			return 'FL';

			case 'Georgia':
			return 'GA';

			case 'Hawaii':
			return 'HI';

			case 'Idaho':
			return 'ID';

			case 'Illinois':
			return 'IL';

			case 'Indiana':
			return 'IN';

			case 'Iowa':
			return 'IA';

			case 'Kansas':
			return 'KS';

			case 'Kentucky':
			return 'KY';

			case 'Louisiana':
			return 'LA';

			case 'Maine':
			return 'ME';

			case 'Maryland':
			return 'MD';

			case 'Massachusetts':
			return 'MA';

			case 'Michigan':
			return 'MI';

			case 'Minnesota':
			return 'MN';

			case 'Mississippi':
			return 'MS';

			case 'Missouri':
			return 'MO';

			case 'Montana':
			return 'MT';

			case 'Nebraska':
			return 'NE';

			case 'Nevada':
			return 'NV';

			case 'New Hampshire':
			return 'NH';

			case 'New Jersey':
			return 'NJ';

			case 'New Mexico':
			return 'NM';

			case 'New York':
			return 'NY';

			case 'North Carolina':
			return 'NC';

			case 'North Dakota':
			return 'ND';

			case 'Ohio':
			return 'OH';

			case 'Oklahoma':
			return 'OK';

			case 'Oregon':
			return 'OR';

			case 'Pennsylvania':
			return 'PA';

			case 'Rhode Island':
			return 'RI';

			case 'South Carolina':
			return 'SC';

			case 'South Dakota':
			return 'SD';

			case 'Tennessee':
			return 'TN';


			case 'Texas':
			return 'TX';

			case 'Utah':
			return 'UT';

			case 'Vermont':
			return 'VT';

			case 'Virginia':
			return 'VA';

			case 'Washington State':
			return 'WA';

			case 'West Virginia':
			return 'WV';

			case 'Wisconsin':
			return 'WI';

			case 'Wyoming':
			return 'WY';

			case 'Puerto Rico':
			return 'PR';



	}
}